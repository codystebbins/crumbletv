// TODO Revisit this!, look at https://gist.github.com/joukokar/57b14e034e41893407f0 and the integration tests for an example.